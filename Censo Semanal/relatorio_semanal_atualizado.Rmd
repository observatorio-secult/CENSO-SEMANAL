---
title: "**Relatório Semanal do Censo Cultural de Pernambuco**"
author: 
  - "Observatório de Indicadores Culturais"
  - "Secretaria de Cultura de Pernambuco"
output: pdf_document
keep_tex: yes
header-includes:
- \usepackage{setspace}
- \usepackage{indentfirst}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
if(require(tidyverse) == F) install.packages("tidyverse"); require(tidyverse)
if(require(openxlsx) == F) install.packages("openxlsx"); require(openxlsx)
if(require(readxl) == F) install.packages("readxl"); require(readxl)
if(require(here) == F) install.packages("here"); require(here)
if(require(lubridate) == F) install.packages("lubridate"); require(lubridate)
theme_set(theme_bw()+ theme(panel.grid = element_blank(),
                              legend.position = "top",
                              axis.text = element_text(face = "bold"))) 
setwd(here("Censo Semanal"))
impedidos <- read.csv("Impedidos.csv")
agentes <- read.csv("Inscritos - Censo (Agentes Culturais).csv") %>%
  filter(Status != "Rascunho")
equipamentos <- read.csv("Inscritos - Censo (Equipamentos).csv") %>% 
  filter(Status != "Rascunho") %>% filter(!`X12..Nome.da.Galeria.de.Arte` %in% impedidos$Impedidos)


```

## Participação

Até o dia `r format(Sys.Date(), format="%d/%m/%Y")` às `r paste0(hour(Sys.time()), "h", minute(Sys.time()))`, `r nrow(agentes)` agentes culturais e `r nrow(equipamentos)` equipamentos responderam ao Censo Cultural de Pernambuco.

## Linguagem

**O gráfico abaixo mostra a quantidade parcial de Agentes Culturais respondentes:**

```{r, echo = F, warning=FALSE}

linguagem <- agentes %>% group_by(`X15..Qual.sua.principal.área.de.atuação.artístico.cultural.`) %>% 
  summarise(respondentes = n()) %>% rename(linguagem = 1)

ggplot(linguagem, aes(x = reorder(linguagem, respondentes), y = respondentes)) +
  geom_segment(aes(xend = linguagem, y = 0, yend = respondentes), color = "grey80", lty = "dashed") +
  geom_point(size = 3, color = "#ff002b") +
  coord_flip() +
  labs(x = "Linguagem", y = "Respondente") +
  geom_text(aes(label = paste0(respondentes, " (", scales::percent(respondentes/sum(respondentes), accuracy = 0.1),
                               ")")), hjust = -.2, size = 3) +
  expand_limits(y = c(0, max(linguagem$respondentes) + max(linguagem$respondentes)/4))
  
  

```

\newpage
## Tipo de Equipamento

**Os `r nrow(equipamentos)` equipamentos respondentes até o momento se distribuem da seguinte forma:**

```{r, echo = F, warning=FALSE}

tipo_eq <- equipamentos %>% group_by(`Sobre.qual.equipamento.cultural.você.estará.respondendo.`) %>% 
  summarise(respondentes = n()) %>% rename(tipo = 1)

tipos_de_equipaments <- data.frame(tipo = c("Museu", "Sala de Cinema", "Teatro", "Espaços de formação em Artes Circenses"),
                                   check = 0)

tipo_eq <- tipo_eq %>% full_join(tipos_de_equipaments, by = "tipo") %>% 
  mutate(respondentes = ifelse(is.na(respondentes) == T, check, respondentes))

ggplot(tipo_eq, aes(x = reorder(tipo, respondentes), y = respondentes)) +
  geom_bar(stat = "identity", fill = "#0c00ff", width = .6) +
  coord_flip() +
  labs(x = "Linguagem", y = "Respondente") +
  geom_text(aes(label = paste0(respondentes, " (", scales::percent(respondentes/sum(respondentes), accuracy = 0.1),
                               ")")), hjust = -.2, size = 3) +
  expand_limits(y = c(0, max(tipo_eq$respondentes) + max(tipo_eq$respondentes)/4))
```

\newpage
## Macrorregião

**O gráfico abaixo mostra a quantidade de respondentes por Macrorregião do estado e o Distrito de Fernando de Noronha.**

```{r, echo = F, warning=FALSE, error=FALSE}

regiao <- agentes %>% group_by(`X5..Em.qual.município.você.reside.ou.está.situado.`) %>% 
  summarise(respondentes = n()) %>% rename(municipio = 1) %>% mutate(municipio = ifelse(municipio == "Águas Preta", "Água Preta",
                                                                                        municipio))

rd_macro <- read_xlsx("RD_Municipio.xlsx")

regiao <- regiao %>% left_join(rd_macro, by = "municipio")

regiao_equip <- equipamentos %>% select(`Sobre.qual.equipamento.cultural.você.estará.respondendo.`,
                                        X13..Qual.o.município.do.Museu., 
                                        X13..Qual.o.município.do.Teatro., 
                                        X13..Qual.o.município.da.Sala.de.Cinema., 
                                        X13..Qual.o.município.do.Espaço.de.formação.em.Artes.Circenses., 
                                        X13..Qual.município.da.Galeria.de.Arte.) %>% 
  gather(key = tipo, value = municipio, -`Sobre.qual.equipamento.cultural.você.estará.respondendo.`) %>% 
  rename(equipamento = 1) %>% 
  mutate(check = ifelse(equipamento == "Museu" &
                          tipo == "X13..Qual.o.município.do.Museu.", 1,
                        ifelse(equipamento == "Teatro" & 
                                 tipo == "X13..Qual.o.município.do.Teatro.", 1,
                               ifelse(equipamento == "Sala de Cinema" &
                                        tipo == "X13..Qual.o.município.da.Sala.de.Cinema.", 1, 
                                      ifelse(equipamento == "Espaço de Formação em Artes Circenses" &
                                               tipo == "X13..Qual.o.município.do.Espaço.de.formação.em.Artes.Circenses.", 1,
                                             ifelse(equipamento == "Galeria de Arte" &
                                                      tipo == "X13..Qual.município.da.Galeria.de.Arte.", 1, 0)))))) %>% 
  filter(check == 1)

regiao_equip <- regiao_equip  %>% 
  mutate(municipio = ifelse(municipio == "Águas Preta", "Água Preta",
                            municipio)) %>% 
  group_by(municipio) %>% summarise(respondentes = n()) %>% 
  left_join(rd_macro, by = "municipio")

regiao <- rbind(regiao %>% mutate(censo = "Agentes Culturais"),
                regiao_equip %>% mutate(censo = "Equipamentos"))


macrorreg <- regiao %>% mutate(macrorreg_new = ifelse(municipio == "Fernando de Noronha", "F. de Noronha", macrorreg_new)) %>% 
  group_by(macrorreg_new, censo) %>% summarise(respondentes = sum(respondentes), .groups = "keep")


ggplot(macrorreg, aes(x = reorder(macrorreg_new, respondentes), y = respondentes)) +
  geom_bar(stat = "identity", aes(fill = censo), width = .6) +
  facet_wrap(~censo, scales = "free_y") +
  labs(x = "Macrorregião", y = "Respondente") +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 15)) +
  geom_text(aes(label = paste0(respondentes, " (", scales::percent(respondentes/sum(respondentes), accuracy = 0.1),
                               ")")), vjust = -.5, size = 3) +
  expand_limits(x = c(0, 6)) +
  scale_fill_manual(values = c("Agentes Culturais" = "#ff002b",
                               "Equipamentos" = "#0c00ff"))
```

\newpage
## Município

**A tabela abaixo mostra a quantidade de respondentes por município.**

```{r, echo=FALSE, warning=FALSE}

a <- regiao %>% mutate(macrorreg_new = ifelse(municipio == "Fernando de Noronha", "-", macrorreg_new),
                       rd = ifelse(municipio == "Fernando de Noronha", "-", rd)) %>% 
  filter(censo == "Agentes Culturais") %>% arrange(-respondentes) %>% 
  select(-censo) %>% rename(Município = 1, Respondentes = 2, Macrorregiao = 3, RD = 4)

knitr::kable(a, align = "lccc")

```
**A tabela abaixo mostra a quantidade de Equipamentos por município.**

```{r, echo=FALSE, warning=FALSE}

a <- regiao %>% mutate(macrorreg_new = ifelse(municipio == "Fernando de Noronha", "-", macrorreg_new),
                       rd = ifelse(municipio == "Fernando de Noronha", "-", rd)) %>% 
  filter(censo == "Equipamentos") %>% arrange(-respondentes) %>% 
  select(-censo) %>% rename(Município = 1, Respondentes = 2, Macrorregiao = 3, RD = 4)

knitr::kable(a, align = "lccc")

```
\newpage
## Comunidade

**Até o momento, as comunidades alcançadas foram as seguintes:**

```{r, echo=FALSE, warning=FALSE}

comunidade <- agentes %>% group_by(`X10..Você.pertence.a.alguma.das.comunidades.listadas.abaixo.`) %>% 
  summarise(respondentes = n()) %>% rename(comunidade = 1)

ggplot(comunidade, aes(x = reorder(comunidade, respondentes), y = respondentes)) +
  geom_segment(aes(xend = comunidade, y = 0, yend = respondentes), color = "grey80", lty = "dashed") +
  geom_point(size = 3, color = "#ff002b") +
  coord_flip() +
  geom_text(aes(label = paste0(respondentes, " (", scales::percent(respondentes/sum(respondentes), accuracy = 0.1),
                               ")")),
            size = 3, hjust = -.2) +
  expand_limits(y = c(0, max(comunidade$respondentes) + max(comunidade$respondentes)/4)) +
  labs(x = "Comunidade", y = "Respondente")

```

## Linguagem por macrorregião


**Aqui temos a distribuição de linguagens culturais por macrorregião:**

```{r, echo = F, warning=FALSE, error=FALSE}

regiao <- agentes %>% mutate(municipio= ifelse(`X5..Em.qual.município.você.reside.ou.está.situado.`== "Águas Preta", "Água Preta",
                                                                                       `X5..Em.qual.município.você.reside.ou.está.situado.`)) %>% 
left_join(rd_macro, by = "municipio")


linguagem_macro<- regiao %>% group_by(`X15..Qual.sua.principal.área.de.atuação.artístico.cultural.`,macrorreg_new) %>% 
  reframe(respondentes= n())%>% spread(macrorreg_new, respondentes)%>% rename("Linguagem Cultural"= 1)


linguagem_macro[is.na(linguagem_macro)] <- 0

knitr::kable(linguagem_macro, align = "lcccc")

```
